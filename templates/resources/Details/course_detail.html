{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% load humanize %}

{% block title %}{{ resource.title }} - Course{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-10">

    <div class="bg-white rounded-xl shadow-xl p-6 mb-8 border-t-4 border-purple-500">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">{{ resource.title }}</h1>
        <p class="text-gray-600 text-lg mb-4">{{ resource.description }}</p>

        <div class="flex flex-wrap gap-6 mt-4 border-t pt-4 text-sm text-gray-700 items-center">
            <span class="flex items-center text-purple-600">
                <i class="fas fa-hourglass-half mr-2"></i>
                Duration: <span class="font-medium ml-1">{{ resource.estimated_duration|naturaltime }}</span>
            </span>
            <span class="flex items-center">
                <i class="fas fa-user-graduate mr-2"></i>
                Creator: <span class="font-medium ml-1">{{ resource.author.username }}</span>
            </span>
            <span class="px-3 py-1 rounded-full text-xs font-medium
                {% if resource.difficulty == 'B' %}bg-green-100 text-green-800{% elif resource.difficulty == 'I' %}bg-yellow-100 text-yellow-800{% else %}bg-red-100 text-red-800{% endif %}">
                Difficulty: {{ resource.get_difficulty_display }}
            </span>

            {% if course_progress and course_roadmap %}
            {% with total_steps=course_roadmap|length current_step=course_progress.current_step %}
                {% if total_steps > 0 %}
                    {% with progress_percent=current_step|floatformat:0|div:total_steps|mul:100 %}
                    <div class="flex-1 min-w-[200px]">
                        <div class="text-xs font-medium text-gray-700 mb-1">
                            Progress: {{ current_step }} of {{ total_steps }} steps ({{ progress_percent }}%)
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-purple-600 h-2.5 rounded-full" style="width: {{ progress_percent }}%"></div>
                        </div>
                    </div>
                    {% endwith %}
                {% endif %}
            {% endwith %}
            {% endif %}
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2">
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                    <i class="fas fa-route text-purple-600 mr-2"></i> Learning Roadmap
                </h2>

                {% if course_roadmap %}
                    <div class="space-y-6" id="course-roadmap">
                        {% for step in course_roadmap %}
                        {% with is_completed=course_progress.current_step|default:0|gte:step.step_number %}
                            <div class="border-l-4 p-4 rounded-lg transition-all
                                {% if is_completed %}border-green-500 bg-green-50{% else %}border-gray-300 bg-gray-50{% endif %}">

                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-lg font-bold text-gray-900 flex items-center">
                                        <span class="mr-3 p-1 rounded-full text-white text-xs font-bold w-6 h-6 flex items-center justify-center
                                            {% if is_completed %}bg-green-600{% else %}bg-gray-400{% endif %}">
                                            {{ step.step_number }}
                                        </span>
                                        {{ step.title }}
                                    </h3>

                                    <button data-step="{{ step.step_number }}" data-course-id="{{ resource.pk }}"
                                            class="progress-toggle-btn px-3 py-1 text-xs rounded-full shadow-sm transition-colors
                                            {% if is_completed %}bg-white text-green-600 border border-green-600 hover:bg-green-100{% else %}bg-purple-600 text-white hover:bg-purple-700{% endif %}">
                                        {% if is_completed %}
                                            <i class="fas fa-check mr-1"></i> Completed
                                        {% else %}
                                            <i class="fas fa-book-reader mr-1"></i> Mark Complete
                                        {% endif %}
                                    </button>
                                </div>

                                <p class="text-sm text-gray-700 mb-3">Content to master this step:</p>

                                <ul class="list-disc list-inside space-y-2 ml-4">
                                    {% for video in step.videos %}
                                        <li class="text-sm text-gray-700 flex items-start">
                                            <i class="fas fa-video text-red-500 mt-1 mr-2"></i>
                                            <a href="{{ video.url }}" target="_blank" class="text-blue-600 hover:underline">
                                                {{ video.title }} ({{ video.duration }})
                                            </a>
                                        </li>
                                    {% empty %}
                                        <li class="text-sm text-gray-500">No primary video content found for this step.</li>
                                    {% endfor %}

                                    {% for internal_res in step.internal_resources %}
                                        <li class="text-sm text-gray-700 flex items-start">
                                            <i class="fas fa-file-alt text-indigo-500 mt-1 mr-2"></i>
                                            <a href="{% url 'resource_detail' resource_slug=internal_res.slug %}" class="text-blue-600 hover:underline">
                                                {{ internal_res.title }} ({{ internal_res.get_resource_type }})
                                            </a>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endwith %}
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-500">The course roadmap is currently being generated or is unavailable.</p>
                {% endif %}
            </div>

            {% include "resources/partials/_comments_section.html" %}

        </div>

        <div class="lg:col-span-1">
            {% include "resources/partials/_interaction_panel.html" with resource=resource user_interaction=user_interaction %}
            {% include "resources/partials/_similar_resources.html" with similar_resources=similar_resources %}
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleButtons = document.querySelectorAll('.progress-toggle-btn');
        const courseId = document.getElementById('course-roadmap')?.dataset.courseId;

        if (!courseId) return;

        toggleButtons.forEach(button => {
            button.addEventListener('click', function() {
                const stepNumber = parseInt(this.dataset.step);
                const isCompleted = this.textContent.includes('Completed');
                const targetUrl = "{% url 'course_progress_update' %}";

                // Optimistically update the UI while waiting for AJAX
                const originalHtml = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                this.disabled = true;

                fetch(targetUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: new URLSearchParams({
                        'course_id': courseId,
                        'step_number': stepNumber,
                        'is_completed': isCompleted ? 'false' : 'true'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('Error updating progress: ' + data.error);
                        this.innerHTML = originalHtml;
                        this.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('AJAX Error:', error);
                    alert('An unexpected error occurred.');
                    this.innerHTML = originalHtml;
                    this.disabled = false;
                });
            });
        });
    });
</script>
{% endblock %}