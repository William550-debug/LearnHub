<!-- templates/resources/Details/course_detail.html -->
{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
    .course-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
    }

    .progress-ring {
        width: 80px;
        height: 80px;
    }

    .progress-ring__circle {
        stroke-width: 4;
        stroke-linecap: round;
        fill: transparent;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
    }

    .module-card {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .module-card:hover {
        border-color: #4f46e5;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .module-header {
        background: #f9fafb;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        cursor: pointer;
    }

    .module-content {
        padding: 1.5rem;
        background: white;
    }

    .video-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        transition: all 0.2s;
    }

    .video-item:hover {
        border-color: #4f46e5;
        background: #f8fafc;
    }

    .video-completed {
        border-color: #10b981;
        background: #f0fdf4;
    }

    .checkmark-circle {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid #d1d5db;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        flex-shrink: 0;
    }

    .checkmark-circle.completed {
        border-color: #10b981;
        background: #10b981;
        color: white;
    }

    .enroll-btn {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        padding: 0.75rem 2rem;
        border-radius: 8px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }

    .enroll-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <!-- Course Hero Section -->
    <div class="course-hero">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
            <div class="flex-1">
                <div class="flex items-center gap-3 mb-3">
                    <span class="difficulty-badge {{ resource.get_difficulty_display|lower }}">
                        {{ resource.get_difficulty_display }}
                    </span>
                    {% if resource.ai_generated %}
                    <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm">
                        AI-Generated
                    </span>
                    {% endif %}
                </div>
                <h1 class="text-3xl md:text-4xl font-bold mb-3">{{ resource.title }}</h1>
                <p class="text-lg opacity-90 mb-4">{{ resource.description }}</p>

                <div class="flex flex-wrap gap-4 text-sm">
                    <span class="flex items-center gap-1">
                        <i class="fas fa-clock"></i>
                        {{ resource.estimated_duration|default:"Duration not specified" }}
                    </span>
                    <span class="flex items-center gap-1">
                        <i class="fas fa-video"></i>
                        {{ resource.get_total_videos }} videos
                    </span>
                    <span class="flex items-center gap-1">
                        <i class="fas fa-user-graduate"></i>
                        {{ resource.get_enrolled_count }} enrolled
                    </span>
                </div>
            </div>

            {% if not enrollment_status %}
            <form method="POST" action="{% url 'course_enroll' resource.id %}">
                {% csrf_token %}
                <button type="submit" class="enroll-btn">
                    <i class="fas fa-rocket"></i>
                    Enroll Now
                </button>
            </form>
            {% else %}
            <!-- Progress Display for enrolled users -->
            <div class="flex items-center gap-4">
                <div class="text-center">
                    <svg class="progress-ring" viewBox="0 0 36 36">
                        <path class="progress-ring__circle"
                              stroke="#e5e7eb"
                              stroke-width="3"
                              d="M18 2.0845
                                a 15.9155 15.9155 0 0 1 0 31.831
                                a 15.9155 15.9155 0 0 1 0 -31.831"
                              fill="none"/>
                        <path class="progress-ring__circle"
                              stroke="#4f46e5"
                              stroke-width="3"
                              stroke-dasharray="{{ progress_percentage }}, 100"
                              d="M18 2.0845
                                a 15.9155 15.9155 0 0 1 0 31.831
                                a 15.9155 15.9155 0 0 1 0 -31.831"
                              fill="none"/>
                    </svg>
                    <span class="block mt-2 font-bold">{{ progress_percentage }}%</span>
                </div>
                <div>
                    <p class="text-sm opacity-80">Your Progress</p>
                    <p class="text-lg font-bold">Keep learning!</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Learning Journey Banner -->
    {% if resource.difficulty_progression %}
    <div class="mb-8 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100">
        <div class="flex items-start gap-4">
            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center flex-shrink: 0">
                <i class="fas fa-chart-line text-blue-600 text-xl"></i>
            </div>
            <div>
                <h3 class="text-lg font-bold text-blue-900 mb-2">ðŸŽ¯ Your Learning Journey</h3>
                <p class="text-blue-800">{{ resource.difficulty_progression }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Course Roadmap -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold mb-6">Course Curriculum</h2>

        {% if course_roadmap %}
        <div class="space-y-4">
            {% for module in course_roadmap %}
            <div class="module-card">
                <div class="module-header" onclick="toggleModule({{ forloop.counter }})">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-lg">Module {{ forloop.counter }}: {{ module.title }}</h3>
                            <p class="text-gray-600 text-sm mt-1">
                                {{ module.video_count }} videos â€¢ {{ module.duration_seconds|duration_format }}
                                {% if module.objectives %}
                                â€¢ {{ module.objectives|length }} learning objectives
                                {% endif %}
                            </p>
                        </div>
                        <i class="fas fa-chevron-down transition-transform" id="module-icon-{{ forloop.counter }}"></i>
                    </div>
                </div>

                <div class="module-content" id="module-content-{{ forloop.counter }}" style="display: none;">
                    {% if module.description %}
                    <p class="text-gray-700 mb-4">{{ module.description }}</p>
                    {% endif %}

                    {% if module.objectives %}
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-900 mb-2">Learning Objectives</h4>
                        <ul class="list-disc list-inside space-y-1 text-gray-600">
                            {% for objective in module.objectives %}
                            <li>{{ objective }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <h4 class="font-medium text-gray-900 mb-3">Videos in this module</h4>
                    <div class="space-y-3">
                        {% for video in module.videos %}
                        <div class="video-item {% if video.is_completed %}video-completed{% endif %}"
                             data-video-id="{{ video.milestone_id|default:'' }}">
                            <div class="checkmark-circle {% if video.is_completed %}completed{% endif %}"
                                 onclick="toggleVideoCompletion(this, '{{ video.milestone_id|default:'' }}')">
                                {% if video.is_completed %}
                                <i class="fas fa-check text-xs"></i>
                                {% endif %}
                            </div>
                            <div class="flex-1">
                                <a href="{{ video.watch_url }}" target="_blank" class="font-medium text-gray-900 hover:text-indigo-600">
                                    {{ video.title }}
                                </a>
                                <div class="flex items-center text-sm text-gray-500 mt-1">
                                    <span>{{ video.duration }}</span>
                                    <span class="mx-2">â€¢</span>
                                    <span>{{ video.channel }}</span>
                                    <span class="mx-2">â€¢</span>
                                    <span>{{ video.views|format_number }} views</span>
                                </div>
                            </div>
                            <a href="{{ video.watch_url }}" target="_blank" class="ml-4 text-gray-400 hover:text-indigo-600">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        </div>
                        {% empty %}
                        <p class="text-gray-500 text-center py-4">No videos available for this module</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12">
            <i class="fas fa-road text-gray-300 text-5xl mb-4"></i>
            <p class="text-gray-500">Course roadmap is being generated...</p>
            <form method="POST" action="{% url 'regenerate_roadmap' resource.id %}" class="mt-4">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Generate Roadmap
                </button>
            </form>
        </div>
        {% endif %}
    </div>

    <!-- Similar Courses -->
    {% if similar_resources %}
    <div class="mt-12">
        <h2 class="text-2xl font-bold mb-6">Similar Courses</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {% for similar in similar_resources %}
            <a href="{% url 'resource_detail' similar.slug %}"
               class="bg-white rounded-xl border border-gray-200 overflow-hidden hover:shadow-lg transition-shadow">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-3">
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">
                            {{ similar.get_resource_type }}
                        </span>
                        <span class="text-sm text-gray-500">
                            {{ similar.difficulty }}
                        </span>
                    </div>
                    <h3 class="font-bold text-lg mb-2">{{ similar.title }}</h3>
                    <p class="text-gray-600 text-sm mb-4">{{ similar.description|truncatewords:20 }}</p>
                    <div class="flex items-center text-sm text-gray-500">
                        <i class="fas fa-user-circle mr-1"></i>
                        <span>{{ similar.author.username }}</span>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    function toggleModule(moduleNumber) {
        const content = document.getElementById(`module-content-${moduleNumber}`);
        const icon = document.getElementById(`module-icon-${moduleNumber}`);

        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.classList.add('rotate-180');
        } else {
            content.style.display = 'none';
            icon.classList.remove('rotate-180');
        }
    }

    function toggleVideoCompletion(circle, milestoneId) {
        if (!milestoneId) return;

        const videoItem = circle.closest('.video-item');
        const isCompleted = videoItem.classList.contains('video-completed');

        // Toggle UI
        if (isCompleted) {
            videoItem.classList.remove('video-completed');
            circle.classList.remove('completed');
            circle.innerHTML = '';
        } else {
            videoItem.classList.add('video-completed');
            circle.classList.add('completed');
            circle.innerHTML = '<i class="fas fa-check text-xs"></i>';
        }

        // Send AJAX request to update progress
        fetch('{% url "update_module_progress" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: new URLSearchParams({
                'module_id': milestoneId,
                'course_id': '{{ resource.id }}',
                'completed': (!isCompleted).toString(),
                'seconds': '300'  // Assume 5 minutes watched for completion
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update progress ring if user is enrolled
                updateProgressRing();
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function updateProgressRing() {
        // Reload the page to update progress
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    }

    // Open first module by default
    document.addEventListener('DOMContentLoaded', function() {
        const firstModule = document.getElementById('module-content-1');
        if (firstModule) {
            firstModule.style.display = 'block';
            document.getElementById('module-icon-1').classList.add('rotate-180');
        }
    });
</script>

<!-- Custom template filters -->
<script>
    // Duration formatter
    function formatDuration(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);

        if (hours > 0) {
            return `${hours}h ${minutes}m`;
        }
        return `${minutes}m`;
    }

    // Number formatter
    function formatNumber(num) {
        if (num >= 1000000) {
            return (num / 1000000).toFixed(1) + 'M';
        } else if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'K';
        }
        return num;
    }
</script>
{% endblock %}