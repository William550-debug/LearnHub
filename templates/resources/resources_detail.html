{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}{{ resource.title }} - LearnHub{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Resource Header -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between mb-6">
            <div class="mb-4 md:mb-0">
                <div class="flex items-center space-x-3 mb-4">
                    <span class="text-3xl">
                        {% if resource.type == 'article' %}üì∞
                        {% elif resource.type == 'video' %}üé•
                        {% elif resource.type == 'course' %}üìö
                        {% elif resource.type == 'book' %}üìñ
                        {% elif resource.type == 'tool' %}üõ†Ô∏è
                        {% else %}üìÑ{% endif %}
                    </span>
                    <div class="flex flex-wrap gap-2">
                        <span class="px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm font-medium">
                            {{ resource.category.name|default:"Uncategorized" }}
                        </span>
                        {% if resource.difficulty == 'beginner' %}
                        <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                            üü¢ Beginner
                        </span>
                        {% elif resource.difficulty == 'intermediate' %}
                        <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium">
                            üü° Intermediate
                        </span>
                        {% elif resource.difficulty == 'advanced' %}
                        <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium">
                            üî¥ Advanced
                        </span>
                        {% endif %}
                    </div>
                </div>

                <h1 class="text-3xl font-bold text-gray-900 mb-4">{{ resource.title }}</h1>

                <div class="flex items-center text-gray-600 mb-6">
                    <a href="{% url 'user_profile' resource.author.email %}" class="flex items-center hover:text-indigo-600">
                        <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                            <span class="text-indigo-600 font-medium">
                                {{ resource.author.first_name|first|upper }}{{ resource.author.last_name|first|upper|default:"" }}
                            </span>
                        </div>
                        <div>
                            <p class="font-medium">
                                {{ resource.author.get_full_name|default:resource.author.email }}
                            </p>
                            <p class="text-sm">Posted {{ resource.created_at|date:"M d, Y" }}</p>
                        </div>
                    </a>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex space-x-3">
                <button class="upvote-btn flex items-center space-x-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 {% if user_interaction.upvoted %}text-indigo-600 border-indigo-300{% endif %}"
                        data-resource-id="{{ resource.pk }}" data-is-upvoted="{{ user_interaction.upvoted|default:'false'|lower }}">
                    <i class="{% if user_interaction.upvoted %}fas{% else %}far{% endif %} fa-thumbs-up text-lg"></i>
                    <span class="font-medium upvote-count">
                        {% if resource.upvote_count %}
                            {{ resource.upvote_count }}
                        {% else %}
                            0
                        {% endif %}
                    </span>
                    <span class="hidden md:inline">Upvotes</span>
                </button>
                <button class="save-btn flex items-center space-x-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 {% if user_interaction.saved %}text-red-500 border-red-300{% endif %}"
                        data-resource-id="{{ resource.pk }}" data-is-saved="{{ user_interaction.saved|default:'false'|lower }}">
                    <i class="{% if user_interaction.saved %}fas{% else %}far{% endif %} fa-bookmark text-lg"></i>
                    <span class="hidden md:inline">Save</span>
                </button>
                <button class="flex items-center space-x-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50" id="share-btn">
                    <i class="fas fa-share-alt text-lg"></i>
                    <span class="hidden md:inline">Share</span>
                </button>
            </div>
        </div>

        <!-- Resource URL -->
        <div class="mb-8">
            <a href="{{ resource.url }}" target="_blank"
               class="inline-flex items-center justify-center w-full md:w-auto bg-indigo-600 text-white px-6 py-4 rounded-lg hover:bg-indigo-700 transition font-medium">
                <i class="fas fa-external-link-alt mr-3"></i>
                Visit Resource
                <i class="fas fa-arrow-right ml-3"></i>
            </a>
            <p class="text-gray-500 text-sm mt-2 break-all">{{ resource.url }}</p>
        </div>

        <!-- Stats Bar -->
        <div class="flex flex-wrap items-center justify-between py-4 border-t border-b border-gray-200">
            <div class="flex items-center space-x-6">
                <span class="flex items-center text-gray-600">
                    <i class="far fa-eye mr-2"></i>
                    <span class="font-medium">
                        {% if resource.view_count %}{{ resource.view_count }}{% else %}0{% endif %} views
                    </span>
                </span>
                <span class="flex items-center text-gray-600">
                    <i class="far fa-comment mr-2"></i>
                    <span class="font-medium">
                        {% if resource.comments.count %}{{ resource.comments.count }}{% else %}0{% endif %} comments
                    </span>
                </span>
                {% if resource.estimated_read_time %}
                <span class="flex items-center text-gray-600">
                    <i class="far fa-clock mr-2"></i>
                    <span>{{ resource.estimated_read_time }} min read</span>
                </span>
                {% endif %}
            </div>
            <div class="mt-2 md:mt-0">
                <span class="text-sm text-gray-500">Last updated: {{ resource.updated_at|date:"M d, Y" }}</span>
            </div>
        </div>
    </div>

    <!-- Resource Content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content -->
        <div class="lg:col-span-2">
            <!-- Description -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">Description</h2>
                <div class="prose max-w-none">
                    <p class="text-gray-700 mb-4">{{ resource.description|linebreaks }}</p>

                    <!-- What You'll Learn - Simplified version -->
                    <h3 class="text-xl font-bold mt-8 mb-4">Key Takeaways</h3>
                    <ul class="space-y-2 mb-6">
                        <!-- Simple approach: Show first 150 characters of description as key points -->
                        {% if resource.description %}
                            {% with desc=resource.description|truncatechars:150 %}
                            <li class="flex items-start">
                                <i class="fas fa-check text-green-500 mt-1 mr-3"></i>
                                <span>{{ desc }}</span>
                            </li>
                            {% endwith %}
                        {% else %}
                            <li class="flex items-start">
                                <i class="fas fa-check text-green-500 mt-1 mr-3"></i>
                                <span>Learn from this comprehensive resource</span>
                            </li>
                        {% endif %}
                    </ul>

                    <h3 class="text-xl font-bold mt-8 mb-4">Tags</h3>
                    <div class="flex flex-wrap gap-2 mb-6">
                        {% for tag in resource.tags.all %}
                        <span class="px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-sm">
                            {{ tag.name }}
                        </span>
                        {% empty %}
                        <span class="px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-sm">
                            No tags specified
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Comments ({% if resource.comments.count %}{{ resource.comments.count }}{% else %}0{% endif %})</h2>
                    <button class="text-indigo-600 font-medium hover:text-indigo-700" id="sort-comments">
                        <i class="fas fa-sort mr-1"></i> Sort by: Newest
                    </button>
                </div>

                <!-- Add Comment Form -->
                {% if request.user.is_authenticated %}
                <div class="mb-8 p-4 border border-gray-200 rounded-lg">
                    <h3 class="font-bold mb-3">Add a Comment</h3>
                    <form id="comment-form">
                        {% csrf_token %}
                        <div class="mb-4">
                            {% render_field comment_form.content class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="4" placeholder="Share your thoughts on this resource..." %}
                        </div>

                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <div class="mb-4 sm:mb-0">
                                <span class="text-gray-600 mr-3">Rate this resource:</span>
                                <div class="inline-flex space-x-1" id="star-rating">
                                    <!-- Simple hardcoded stars -->
                                    <button type="button" class="star text-2xl text-gray-300 hover:text-yellow-400" data-rating="1">
                                        <i class="far fa-star"></i>
                                    </button>
                                    <button type="button" class="star text-2xl text-gray-300 hover:text-yellow-400" data-rating="2">
                                        <i class="far fa-star"></i>
                                    </button>
                                    <button type="button" class="star text-2xl text-gray-300 hover:text-yellow-400" data-rating="3">
                                        <i class="far fa-star"></i>
                                    </button>
                                    <button type="button" class="star text-2xl text-gray-300 hover:text-yellow-400" data-rating="4">
                                        <i class="far fa-star"></i>
                                    </button>
                                    <button type="button" class="star text-2xl text-gray-300 hover:text-yellow-400" data-rating="5">
                                        <i class="far fa-star"></i>
                                    </button>
                                </div>
                                <input type="hidden" name="rating" id="rating-value" value="0">
                            </div>
                            <button type="submit" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 font-medium">
                                Post Comment
                            </button>
                        </div>
                    </form>
                </div>
                {% else %}
                <div class="mb-8 p-4 border border-gray-200 rounded-lg text-center">
                    <p class="text-gray-600 mb-3">You need to be logged in to add comments.</p>
                    <a href="{% url 'login' %}?next={{ request.path }}" class="text-indigo-600 hover:text-indigo-700 font-medium">
                        Log in to comment
                    </a>
                </div>
                {% endif %}

                <!-- Comments List -->
                <div id="comments-list">
                    {% for comment in comments %}
                    <div class="comment border-b border-gray-200 pb-6 mb-6">
                        <div class="flex items-start mb-4">
                            <a href="{% url 'user_profile' comment.author.email %}" class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                                    <span class="text-indigo-600 font-medium">
                                        {{ comment.author.first_name|first|upper }}{{ comment.author.last_name|first|upper|default:"" }}
                                    </span>
                                </div>
                            </a>
                            <div class="flex-1">
                                <div class="flex flex-wrap items-center justify-between mb-2">
                                    <div>
                                        <a href="{% url 'user_profile' comment.author.email %}" class="font-bold hover:text-indigo-600">
                                            {{ comment.author.get_full_name|default:comment.author.email }}
                                        </a>
                                        <span class="text-gray-500 text-sm ml-2">{{ comment.created_at|timesince }} ago</span>
                                    </div>
                                    {% if comment.rating %}
                                    <div class="flex items-center text-yellow-400">
                                        {% with ''|center:5 as range %}
                                        {% for _ in range %}
                                            {% if forloop.counter <= comment.rating %}
                                                <i class="fas fa-star text-sm"></i>
                                            {% else %}
                                                <i class="far fa-star text-sm"></i>
                                            {% endif %}
                                        {% endfor %}
                                        {% endwith %}
                                    </div>
                                    {% endif %}
                                </div>
                                <p class="text-gray-700">{{ comment.content }}</p>
                                <div class="mt-3 flex items-center space-x-4">
                                    <button class="text-gray-500 hover:text-indigo-600 text-sm">
                                        <i class="far fa-thumbs-up mr-1"></i>
                                        {% if comment.likes.count %}
                                            {{ comment.likes.count }}
                                        {% else %}
                                            0
                                        {% endif %}
                                    </button>
                                    <button class="text-gray-500 hover:text-indigo-600 text-sm">
                                        Reply
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div id="no-comments" class="text-center py-12">
                        <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-gray-100 flex items-center justify-center">
                            <i class="fas fa-comment text-3xl text-gray-400"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">No comments yet</h3>
                        <p class="text-gray-600 mb-6">Be the first to share your thoughts!</p>
                    </div>
                    {% endfor %}
                </div>

                <!-- Load More Comments -->
                {% if comments|length > 5 %}
                <div class="text-center mt-8">
                    <button class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium">
                        Load More Comments
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1">
            <!-- Similar Resources -->
            {% if similar_resources %}
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="font-bold text-lg mb-4">Similar Resources</h3>
                <div class="space-y-4">
                    {% for similar in similar_resources %}
                    <a href="{% url 'resource_detail' similar.slug %}" class="block p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                        <div class="flex items-start">
                            <span class="text-xl mr-3">
                                {% if similar.type == 'article' %}üì∞
                                {% elif similar.type == 'video' %}üé•
                                {% elif similar.type == 'course' %}üìö
                                {% elif similar.type == 'book' %}üìñ
                                {% elif similar.type == 'tool' %}üõ†Ô∏è
                                {% else %}üìÑ{% endif %}
                            </span>
                            <div>
                                <h4 class="font-medium line-clamp-2">{{ similar.title }}</h4>
                                <div class="flex items-center mt-2 text-sm text-gray-500">
                                    <span class="mr-3">{{ similar.category.name|default:"Uncategorized" }}</span>
                                    <span class="capitalize">{{ similar.difficulty }}</span>
                                </div>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Resource Stats -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="font-bold text-lg mb-4">Resource Stats</h3>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-gray-600">Engagement Rate</span>
                            <span class="font-medium">
                                {% if resource.view_count and resource.upvote_count and resource.view_count > 0 %}
                                    {% widthratio resource.upvote_count resource.view_count 100 %}%
                                {% else %}
                                    0%
                                {% endif %}
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full" style="width:
                                {% if resource.view_count and resource.upvote_count and resource.view_count > 0 %}
                                    {% widthratio resource.upvote_count resource.view_count 100 %}%
                                {% else %}
                                    0%
                                {% endif %}
                            "></div>
                        </div>
                    </div>

                    <div class="pt-4 border-t border-gray-200">
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div>
                                <div class="text-2xl font-bold text-indigo-600">
                                    {% if resource.save_count %}{{ resource.save_count }}{% else %}0{% endif %}
                                </div>
                                <div class="text-sm text-gray-500">Saves</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-green-600">
                                    {% if resource.comments.count %}{{ resource.comments.count }}{% else %}0{% endif %}
                                </div>
                                <div class="text-sm text-gray-500">Comments</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report/Edit Actions -->
            <div class="mt-6 space-y-3">
                {% if request.user.is_authenticated %}
                <button class="w-full py-2 text-center text-gray-600 hover:text-red-600 border border-gray-300 rounded-lg">
                    <i class="fas fa-flag mr-2"></i> Report Resource
                </button>
                {% endif %}

                {% if user_is_creator %}
                <a href="{% url 'resource_interaction' %}" class="block w-full py-2 text-center text-gray-600 hover:text-indigo-600 border border-gray-300 rounded-lg">
                    <i class="fas fa-edit mr-2"></i> Edit Resource
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // Add this at the top of your JavaScript section
    const resourceId = {{ resource.pk|default:0 }};
    const csrfToken = "{{ csrf_token }}";

    // Only run JavaScript if we have a valid resource
    if (resourceId > 0) {
        // Upvote button functionality
        document.querySelectorAll('.upvote-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();

                const resourceId = this.getAttribute('data-resource-id');
                const isUpvoted = this.getAttribute('data-is-upvoted') === 'true';

                // Make AJAX request to upvote endpoint
                fetch(`/api/resources/${resourceId}/upvote/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        upvoted: !isUpvoted
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Update button state
                        const icon = this.querySelector('i');
                        const countSpan = this.querySelector('.upvote-count');

                        if (data.upvoted) {
                            icon.classList.remove('far');
                            icon.classList.add('fas');
                            this.classList.add('text-indigo-600', 'border-indigo-300');
                        } else {
                            icon.classList.remove('fas');
                            icon.classList.add('far');
                            this.classList.remove('text-indigo-600', 'border-indigo-300');
                        }

                        // Update count
                        if (data.upvote_count !== undefined) {
                            countSpan.textContent = data.upvote_count;
                        }

                        // Update data attribute
                        this.setAttribute('data-is-upvoted', data.upvoted.toString());
                    } else {
                        alert(data.error || 'Failed to update vote');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to update vote. Please try again.');
                });
            });
        });

        // Save button functionality
        document.querySelectorAll('.save-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();

                const resourceId = this.getAttribute('data-resource-id');
                const isSaved = this.getAttribute('data-is-saved') === 'true';

                // Make AJAX request to save endpoint
                fetch(`/api/resources/${resourceId}/save/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        saved: !isSaved
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Update button state
                        const icon = this.querySelector('i');

                        if (data.saved) {
                            icon.classList.remove('far');
                            icon.classList.add('fas');
                            this.classList.add('text-red-500', 'border-red-300');
                        } else {
                            icon.classList.remove('fas');
                            icon.classList.add('far');
                            this.classList.remove('text-red-500', 'border-red-300');
                        }

                        // Update data attribute
                        this.setAttribute('data-is-saved', data.saved.toString());
                    } else {
                        alert(data.error || 'Failed to save resource');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to save resource. Please try again.');
                });
            });
        });
    }

    // Star Rating System
    const stars = document.querySelectorAll('.star');
    const ratingValue = document.getElementById('rating-value');

    if (stars.length > 0) {
        stars.forEach(star => {
            star.addEventListener('click', function() {
                const rating = parseInt(this.getAttribute('data-rating'));
                ratingValue.value = rating;

                // Update star display
                stars.forEach((s, index) => {
                    const starIndex = parseInt(s.getAttribute('data-rating'));
                    if (starIndex <= rating) {
                        s.innerHTML = '<i class="fas fa-star"></i>';
                        s.classList.remove('text-gray-300');
                        s.classList.add('text-yellow-400');
                    } else {
                        s.innerHTML = '<i class="far fa-star"></i>';
                        s.classList.remove('text-yellow-400');
                        s.classList.add('text-gray-300');
                    }
                });
            });

            // Hover effect
            star.addEventListener('mouseover', function() {
                const rating = parseInt(this.getAttribute('data-rating'));
                stars.forEach((s, index) => {
                    const starIndex = parseInt(s.getAttribute('data-rating'));
                    if (starIndex <= rating) {
                        s.classList.add('text-yellow-300');
                    }
                });
            });

            star.addEventListener('mouseout', function() {
                const currentRating = parseInt(ratingValue.value);
                stars.forEach((s, index) => {
                    const starIndex = parseInt(s.getAttribute('data-rating'));
                    if (starIndex > currentRating) {
                        s.classList.remove('text-yellow-300');
                    }
                });
            });
        });
    }

    // Comment Form Submission
    const commentForm = document.getElementById('comment-form');
    if (commentForm) {
        commentForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const textarea = this.querySelector('textarea');
            const commentText = textarea ? textarea.value : '';
            const rating = ratingValue ? parseInt(ratingValue.value) : 0;

            if (!commentText.trim()) {
                alert('Please enter a comment');
                return;
            }

            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            if (!submitBtn) return;

            const originalText = submitBtn.textContent;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Posting...';
            submitBtn.disabled = true;

            // Make AJAX request to post comment
            fetch(`/api/resources/${resourceId}/comment/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    content: commentText,
                    rating: rating
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Create new comment element
                    const newComment = document.createElement('div');
                    newComment.className = 'comment border-b border-gray-200 pb-6 mb-6';

                    let starsHTML = '';
                    if (rating > 0) {
                        for (let i = 1; i <= 5; i++) {
                            if (i <= rating) {
                                starsHTML += '<i class="fas fa-star"></i>';
                            } else {
                                starsHTML += '<i class="far fa-star"></i>';
                            }
                        }
                    }

                    newComment.innerHTML = `
                        <div class="flex items-start mb-4">
                            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                                <span class="text-indigo-600 font-medium">You</span>
                            </div>
                            <div class="flex-1">
                                <div class="flex flex-wrap items-center justify-between mb-2">
                                    <div>
                                        <span class="font-bold">You</span>
                                        <span class="text-gray-500 text-sm ml-2">Just now</span>
                                    </div>
                                    ${rating > 0 ? `<div class="flex items-center text-yellow-400">${starsHTML}</div>` : ''}
                                </div>
                                <p class="text-gray-700">${commentText}</p>
                                <div class="mt-3 flex items-center space-x-4">
                                    <button class="text-gray-500 hover:text-indigo-600 text-sm">
                                        <i class="far fa-thumbs-up mr-1"></i> 0
                                    </button>
                                    <button class="text-gray-500 hover:text-indigo-600 text-sm">
                                        Reply
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;

                    // Insert at beginning of comments list
                    const commentsList = document.getElementById('comments-list');
                    if (commentsList) {
                        const firstComment = commentsList.querySelector('.comment');
                        if (firstComment) {
                            commentsList.insertBefore(newComment, firstComment);
                        } else {
                            commentsList.appendChild(newComment);
                            const noComments = document.getElementById('no-comments');
                            if (noComments) noComments.classList.add('hidden');
                        }
                    }

                    // Update comment count
                    const commentCount = document.querySelector('h2.text-2xl.font-bold');
                    if (commentCount) {
                        const currentText = commentCount.textContent;
                        const match = currentText.match(/\((\d+)\)/);
                        const currentCount = match ? parseInt(match[1]) : 0;
                        commentCount.textContent = `Comments (${currentCount + 1})`;
                    }

                    // Reset form
                    this.reset();
                    if (ratingValue) ratingValue.value = 0;

                    if (stars.length > 0) {
                        stars.forEach(s => {
                            s.innerHTML = '<i class="far fa-star"></i>';
                            s.classList.remove('text-yellow-400');
                            s.classList.add('text-gray-300');
                        });
                    }

                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'mb-4 p-3 bg-green-50 text-green-700 rounded-lg';
                    successMsg.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Comment posted successfully!';
                    this.parentNode.insertBefore(successMsg, this);

                    setTimeout(() => {
                        if (successMsg.parentNode) {
                            successMsg.parentNode.removeChild(successMsg);
                        }
                    }, 3000);
                } else {
                    alert(data.error || 'Failed to post comment');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to post comment. Please try again.');
            })
            .finally(() => {
                // Reset button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });
    }

    // Share functionality
    const shareBtn = document.getElementById('share-btn');
    if (shareBtn) {
        shareBtn.addEventListener('click', function() {
            if (navigator.share) {
                navigator.share({
                    title: '{{ resource.title }}',
                    text: 'Check out this learning resource on LearnHub',
                    url: window.location.href,
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(window.location.href).then(() => {
                    // Show feedback
                    const originalHTML = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-check mr-2"></i> Copied!';
                    setTimeout(() => {
                        this.innerHTML = originalHTML;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('Failed to copy URL to clipboard');
                });
            }
        });
    }
</script>
{% endblock %}