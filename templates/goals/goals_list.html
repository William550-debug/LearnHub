<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}My Learning Goals (Kanban) - LearnHub{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Learning Goals Tracker</h1>
        <button id="add-goal-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 font-medium">
            <i class="fas fa-plus mr-2"></i> Add New Goal
        </button>
    </div>

    <div class="flex space-x-4 overflow-x-auto pb-4">
        {% for status_name, goal_list in kanban_columns.items %}
        <div class="flex-shrink-0 w-80 bg-gray-100 rounded-xl p-4 shadow-inner border border-gray-200">
            <h2 class="font-bold text-lg mb-4 flex justify-between items-center">
                <span>
                    {% if status_name == 'Not Started' %}ðŸŽ¯
                    {% elif status_name == 'In Progress' %}ðŸš€
                    {% elif status_name == 'Completed' %}ðŸŽ‰
                    {% elif status_name == 'Archived' %}ðŸ“¦
                    {% endif %}
                    {{ status_name }}
                </span>
                <span class="text-sm font-normal text-gray-500">{{ goal_list|length }}</span>
            </h2>

            <div class="space-y-4 min-h-[50px] goal-column" data-status="{{ status_name }}">
                {% for goal in goal_list %}
                <div class="bg-white rounded-lg shadow-md p-4 border border-gray-200 goal-card card-hover" data-goal-id="{{ goal.pk }}">
                    <h3 class="font-bold text-lg mb-2 line-clamp-2 hover:text-indigo-600 cursor-pointer">{{ goal.title }}</h3>
                    <p class="text-sm text-gray-600 mb-3 line-clamp-3">{{ goal.description }}</p>

                    {% with progress=goal.progress_percentage %}
                    <div class="mb-3">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span>Progress:</span>
                            <span class="font-medium">{{ progress }}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-indigo-600 h-2 rounded-full progress-bar" style="width: {{ progress }}%"></div>
                        </div>
                    </div>
                    {% endwith %}

                    <div class="mt-4 pt-3 border-t border-gray-100">
                        <h4 class="font-medium text-sm mb-2 text-gray-700">Milestones ({{ goal.milestone_completed_count }}/{{ goal.milestone_count }})</h4>
                        <ul class="space-y-1">
                            {% for milestone in goal.milestones.all|slice:":3" %}
                            <li class="flex items-center text-sm text-gray-700">
                                <input type="checkbox"
                                       {% if milestone.is_completed %}checked{% endif %}
                                       data-milestone-id="{{ milestone.pk }}"
                                       class="milestone-toggle h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded mr-2 cursor-pointer">
                                <span class="{% if milestone.is_completed %}line-through text-gray-500{% endif %} line-clamp-1">
                                    {{ milestone.title }}
                                </span>
                            </li>
                            {% empty %}
                            <p class="text-xs text-gray-500">No milestones set.</p>
                            {% endfor %}
                        </ul>
                    </div>

                    <div class="mt-3 text-xs text-gray-500 flex justify-between">
                        <span>Due: {{ goal.due_date|default:"N/A"|date:"M d, Y" }}</span>
                        <a href="#" class="text-indigo-600 hover:text-indigo-700">View Details</a>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-6 text-gray-500 border-2 border-dashed border-gray-300 rounded-lg">
                    <i class="fas fa-clipboard-list text-2xl mb-2"></i>
                    <p class="text-sm">No goals here yet!</p>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div id="goal-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold">Add New Learning Goal</h3>
            <button id="close-modal-btn" class="text-gray-500 hover:text-gray-900">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <form method="POST" action="{% url 'goal_create' %}">
            {% csrf_token %}

            <div class="space-y-4">
                <div>
                    <label for="{{ new_goal_form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                    {{ new_goal_form.title|add_class:"w-full px-4 py-2 border border-gray-300 rounded-lg" }}
                </div>

                <div>
                    <label for="{{ new_goal_form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    {{ new_goal_form.description|add_class:"w-full px-4 py-2 border border-gray-300 rounded-lg" }}
                </div>

                <div>
                    <label for="{{ new_goal_form.due_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                    {{ new_goal_form.due_date|add_class:"w-full px-4 py-2 border border-gray-300 rounded-lg" }}
                </div>

                {# Hidden fields for user and status default will be set in view #}

                <div class="pt-4">
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 font-medium">
                        Create Goal
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

{% endblock content %}

{% block extra_js %}
<script>
    // Modal Logic
    const goalModal = document.getElementById('goal-modal');
    const addGoalBtn = document.getElementById('add-goal-btn');
    const closeModalBtn = document.getElementById('close-modal-btn');

    addGoalBtn.addEventListener('click', () => {
        goalModal.classList.remove('hidden');
    });

    closeModalBtn.addEventListener('click', () => {
        goalModal.classList.add('hidden');
    });

    goalModal.addEventListener('click', (e) => {
        if (e.target === goalModal) {
            goalModal.classList.add('hidden');
        }
    });

    // Animate progress bars on page load
    document.addEventListener('DOMContentLoaded', function() {
        const progressBars = document.querySelectorAll('.progress-bar');

        progressBars.forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0%';

            setTimeout(() => {
                bar.style.width = width;
            }, 300);
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
    // ... (rest of DOMContentLoaded logic) ...

    // Attach event listeners to all milestone checkboxes
    document.querySelectorAll('.milestone-toggle').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const milestoneId = this.getAttribute('data-milestone-id');
            const listItem = this.closest('li');

            // Optimistic UI Update
            const isChecked = this.checked;
            if (isChecked) {
                listItem.querySelector('span').classList.add('line-through', 'text-gray-500');
            } else {
                listItem.querySelector('span').classList.remove('line-through', 'text-gray-500');
            }

            // Disable interactions while fetching
            this.disabled = true;

            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch(`{% url "milestone_toggle" 0 %}`.replace('0', milestoneId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                },
                body: new URLSearchParams({}) // Empty body is fine for a toggle POST
            })
            .then(response => response.json())
            .then(data => {
                this.disabled = false;
                if (data.success) {
                    showToast(`Milestone status updated! Goal progress: ${data.progress_percent}%`, 'success');

                    // CRITICAL: Update the related goal card's progress and status
                    const goalCard = this.closest('.goal-card');
                    const progressBar = goalCard.querySelector('.progress-bar');
                    const progressSpan = goalCard.querySelector('.progress-bar').parentNode.querySelector('span:last-child');

                    // 1. Update Progress
                    progressBar.style.width = `${data.progress_percent}%`;
                    progressSpan.textContent = `${data.progress_percent}%`;

                    // 2. Update Status (visual change)
                    if (data.goal_status_code === 'C') {
                        // If completed, find the status badge and update
                        const badge = goalCard.querySelector('.goal-column').querySelector('h2').querySelector('span:last-child');
                        if (badge) badge.textContent = 'Completed';
                        progressBar.classList.add('bg-green-500');
                    } else if (data.goal_status_code === 'I' && data.progress_percent > 0) {
                        progressBar.classList.remove('bg-green-500');
                        progressBar.classList.add('bg-indigo-600');
                    }

                    // 3. Simple Relocation (Full Kanban drag-and-drop is Phase 5, but status might change the display)
                    if (data.goal_status_code !== goalCard.closest('.goal-column').getAttribute('data-status').slice(0, 1)) {
                         // Suggest that the user might need to refresh or the card should be moved (future implementation)
                         showToast(`Goal status automatically updated to ${data.goal_status}.`, 'info');
                    }

                } else {
                    // Revert UI on failure
                    this.checked = !this.checked;
                    if (this.checked) {
                        listItem.querySelector('span').classList.add('line-through', 'text-gray-500');
                    } else {
                        listItem.querySelector('span').classList.remove('line-through', 'text-gray-500');
                    }
                    showToast(data.error || 'Failed to update milestone.', 'error');
                }
            })
            .catch(error => {
                this.disabled = false;
                this.checked = !this.checked; // Revert on network error
                showToast('Network error during milestone update.', 'error');
            });
        });
    });




    // Drag-and-drop setup (Placeholder for Phase 5)
    // We'll integrate a library like Sortable.js here later to manage Kanban column status updates via AJAX.
</script>
{% endblock extra_js %}

</body>
</html>